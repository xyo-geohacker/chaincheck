generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Driver {
  id                 String   @id @default(uuid())
  driverId           String   @unique
  passwordHash       String
  xyoNfcUserRecord   String? // NFC Record 1 (user record)
  xyoNfcSerialNumber String? // NFC Serial number
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([driverId])
}

model Delivery {
  id                String         @id @default(uuid())
  orderId           String         @unique
  driverId          String
  recipientName     String
  recipientPhone    String
  deliveryAddress   String
  destinationLat    Float
  destinationLon    Float
  proofHash         String?        @unique
  boundWitnessData  Json?
  blockNumber       Int?
  verifiedAt        DateTime?
  actualLat         Float?
  actualLon         Float?
  distanceFromDest  Float?
  photoIpfsHash     String?
  photoHash         String? // SHA-256 hash of the photo for tamper detection
  signatureIpfsHash String?
  signatureHash     String? // SHA-256 hash of the signature for tamper detection
  notes             String?
  status            DeliveryStatus @default(PENDING)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Payment fields
  requiresPaymentOnDelivery Boolean @default(false) // Whether payment is required upon delivery verification
  paymentCurrency       String?  // Payment currency (e.g., "XL1", "USD", "ETH")
  buyerWalletAddress    String?
  sellerWalletAddress   String?
  paymentAmount         Float?   // Amount in payment currency (e.g., 1.0 XL1 or 100.00 USD)
  paymentStatus         PaymentStatus @default(PENDING)
  paymentTransactionHash String? @unique
  paymentBlockNumber    Int?
  paymentError          String?  // Error message if payment fails
  
  // Escrow fields (for smart contract escrow)
  escrowContractAddress String?  // Address of escrow contract for this delivery
  escrowDepositTxHash   String?  // Transaction hash when buyer deposited to escrow
  escrowDepositBlock    Int?     // Block number of escrow deposit
  escrowReleaseTxHash   String?  // Transaction hash when escrow released to seller
  escrowReleaseBlock    Int?     // Block number of escrow release
  escrowRefundTxHash    String?  // Transaction hash when escrow refunded to buyer
  escrowRefundBlock     Int?     // Block number of escrow refund

  @@index([driverId])
  @@index([proofHash])
  @@index([buyerWalletAddress])
  @@index([sellerWalletAddress])
  @@index([paymentStatus])
  @@index([escrowContractAddress])
}

enum DeliveryStatus {
  PENDING
  IN_TRANSIT
  DELIVERED
  FAILED
  DISPUTED
}

enum PaymentStatus {
  PENDING    // Payment not yet initiated
  ESCROWED   // Payment held in escrow (optional, for future smart contract integration)
  PAID       // Payment successfully transferred
  FAILED     // Payment transfer failed
  REFUNDED   // Payment refunded to buyer
}

model Configuration {
  id          String   @id @default(uuid())
  category    String // 'backend', 'web', 'mobile'
  key         String
  value       String?
  description String?
  isSecret    Boolean  @default(false) // If true, value is masked in UI
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([category, key])
  @@index([category])
}

model ConfigurationUser {
  id           String   @id @default(uuid())
  username     String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([username])
}
